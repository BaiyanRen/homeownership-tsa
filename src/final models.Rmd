---
title: "dynamic regression"
author: "Leon Chen"
date: "11/12/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

load package
```{r}
library(fpp2)
library(TSA)
library(aod)
library(urca)
library(tseries)
library(mgcv)
library(vars)
library(lmtest)
```

read data
```{r}
hosr <- read.csv("~/Documents/GitHub/homeownership-tsa/data/hosr_var.csv")
#setwd("C:/Users/emrqyw7/OneDrive - McKesson Corporation/Training/OMSCS/tsa/tsa_code/project")
#hosr <- read.csv("data/hosr_var.csv")
n <- length(hosr$hosr)
hosr_log <- log(subset(hosr,select = -c(year,date,quarter)))

# set last 15 data points as testing
training <- hosr[1:(n-15),]
testing <- hosr[(n-14):n,]

# log transformation
training_log <- hosr_log[1:(n-15),]
testing_log <- hosr_log[(n-14):n,]
n
```

```{r}
ts_hosr <-ts(hosr["hosr"],start = 1980, freq = 4)
ts_fedfunds <-ts(hosr["FEDFUNDS"],start = 1980, freq = 4)
ts_mspus <-ts(hosr["MSPUS"],start = 1980, freq = 4)
ts_gdp <-ts(hosr["GDPC1"],start = 1980, freq = 4)
ts_payem <-ts(hosr["PAYEMS"],start = 1980, freq = 4)
ts_cpi <-ts(hosr["CPIAUCSL"],start = 1980, freq = 4)
ts_unrate <-ts(hosr["UNRATE"],start = 1980, freq = 4)
ts_umcsent <-ts(hosr["UMCSENT"],start = 1980, freq = 4)
ts_dispic <-ts(hosr["DSPIC96"],start = 1980, freq = 4)
ts_permit <-ts(hosr["PERMIT"],start = 1980, freq = 4)
ts_icsa <-ts(hosr["ICSA"],start = 1980, freq = 4)
ts_sp500 <-ts(hosr["SP500"],start = 1980, freq = 4)

ts_hosr_log <-ts(hosr_log["hosr"],start = 1980, freq = 4)
ts_fedfunds_log <-ts(hosr_log["FEDFUNDS"],start = 1980, freq = 4)
ts_mspus_log <-ts(hosr_log["MSPUS"],start = 1980, freq = 4)
ts_gdp_log <-ts(hosr_log["GDPC1"],start = 1980, freq = 4)
ts_payem_log <-ts(hosr_log["PAYEMS"],start = 1980, freq = 4)
ts_cpi_log <-ts(hosr_log["CPIAUCSL"],start = 1980, freq = 4)
ts_unrate_log <-ts(hosr_log["UNRATE"],start = 1980, freq = 4)
ts_umcsent_log <-ts(hosr_log["UMCSENT"],start = 1980, freq = 4)
ts_dispic_log <-ts(hosr_log["DSPIC96"],start = 1980, freq = 4)
ts_permit_log <-ts(hosr_log["PERMIT"],start = 1980, freq = 4)
ts_icsa_log <-ts(hosr_log["ICSA"],start = 1980, freq = 4)
ts_sp500_log <-ts(hosr_log["SP500"],start = 1980, freq = 4)
```

```{r}
### Benchmark models

# Original data

points <- 1:length(hosr$date)
points <- (points - min(points))/max(points)
# 1. Fit a moving average model
mav_model <- ksmooth(points, hosr$hosr, kernel = "box")
mav_fit <- ts(mav_model$y, start = 1980, frequency = 4)
# 2. Fit mean model
mean_model <- meanf(ts_hosr)
mean_fit <- ts(mean_model$fitted, start = 1980, frequency = 4)
# 3. Fit drift model
drift_model <- rwf(ts_hosr,12,drift=TRUE)
drift_fit <- ts(drift_model$fitted, start = 1980, frequency = 4)
# 4. Fit naive model
naive_model <- naive(ts_hosr,12)
naive_fit <- ts(naive_model$fitted, start = 1980, frequency = 4)

# Splines Trend Estimation
gam_model <- gam(ts_hosr~s(points))
gam_fit <- ts(fitted(gam_model),start=1980,frequency=4)


#parametric quadraric polynomial
x1 = points
x2 =points^2
para_model = lm(ts_hosr~x1+x2)
para_fit = ts(fitted(para_model),start=1980,frequency=4)


# plot
ts.plot(ts_hosr,xlab="",ylab="homeownership rate",main = "Trend Estimation with Benchmark model")
lines(mav_fit,lwd=2,col="blue")
lines(mean_fit,lwd=2,col="red")
lines(drift_fit,lwd=2,col="green")
lines(naive_fit,lwd=2,col="yellow")
lines(gam_fit,lwd=2,col="purple")
lines(para_fit,lwd=2,col="orange")
legend("topleft", legend = c("mav", "mean", "drift", "naive","Splines regression","parametric quadraric polynomial"),
col = c("blue", "red", "green", "yellow","purple","orange"), lwd = 2)



# Log Data

# 1. Fit a moving average model
mav_model_log <- ksmooth(points, ts_hosr_log, kernel = "box")
mav_fit_log <- ts(mav_model_log$y, start = 1980, frequency = 4)

# 2. Fit mean model
mean_model_log <- meanf(ts_hosr_log)
mean_fit_log <- ts(mean_model_log$fitted, start = 1980, frequency = 4)
# 3. Fit drift model
drift_model_log <- rwf(ts_hosr_log,12,drift=TRUE)
drift_fit_log <- ts(drift_model_log$fitted, start = 1980, frequency = 4)
# 4. Fit naive model
naive_model_log <- naive(ts_hosr_log,12)
naive_fit_log <- ts(naive_model_log$fitted, start = 1980, frequency = 4)

# Splines Trend Estimation
gam_model_log <- gam(ts_hosr_log~s(points))
gam_fit_log <- ts(fitted(gam_model_log),start=1980,frequency=4)


#parametric quadraric polynomial
x1 = points
x2 =points^2
para_model_log = lm(ts_hosr_log~x1+x2)
para_fit_log = ts(fitted(para_model_log),start=1980,frequency=4)


# plot
ts.plot(ts_hosr_log,xlab="",ylab="homeownership rate",main = "Trend Estimation with Benchmark model")
lines(mav_fit_log,lwd=2,col="blue")
lines(mean_fit_log,lwd=2,col="red")
lines(drift_fit_log,lwd=2,col="green")
lines(naive_fit_log,lwd=2,col="yellow")
lines(gam_fit_log,lwd=2,col="purple")
lines(para_fit_log,lwd=2,col="orange")
legend("topleft", legend = c("mav", "mean", "drift", "naive","Splines regression","parametric quadraric polynomial"),
col = c("blue", "red", "green", "yellow","purple","orange"), lwd = 2)
```



```{r}
par(mfrow=c(3,2))
plot(ts_hosr, type="l", main=paste("homeowership rate"),ylab="")
plot(ts_fedfunds, type="l", main=paste("interet rate"),ylab="")
plot(ts_mspus, type="l", main=paste("median housing price"),ylab="")
plot(ts_gdp, type="l", main=paste("GDP"),ylab="")
plot(ts_payem, type="l", main=paste("Non farm payroll"),ylab="")
plot(ts_cpi, type="l", main=paste("CPI"),ylab="")
plot(ts_unrate, type="l", main=paste("Unemployment rate"),ylab="")
plot(ts_umcsent, type="l", main=paste("consumer sentiment"),ylab="")
plot(ts_dispic, type="l", main=paste("Disposible income"),ylab="")
plot(ts_permit, type="l", main=paste("Housing permit"),ylab="")
plot(ts_icsa, type="l", main=paste("Jobless claim"),ylab="")
plot(ts_sp500, type="l", main=paste("S&P 500"),ylab="")
```
Housing permit and consumer sentiment seems to have a very similar pattern as the home ownership rate, while interest rate might exhibit negative relationship with homeowership rate. Log transformation might be needed variables like Non farm payroll, median housing price for them to show more clear correlation with the target.

##1st Order Time Series##

```{r}
par(mfrow=c(3,2))
plot(diff(ts_hosr), type="l", main=paste("homeowership rate"),ylab="")
plot(diff(ts_fedfunds), type="l", main=paste("interet rate"),ylab="")
plot(diff(ts_mspus), type="l", main=paste("median housing price"),ylab="")
plot(diff(ts_gdp), type="l", main=paste("GDP"),ylab="")
plot(diff(ts_payem), type="l", main=paste("Non farm payroll"),ylab="")
plot(diff(ts_cpi), type="l", main=paste("CPI"),ylab="")
plot(diff(ts_unrate), type="l", main=paste("Unemployment rate"),ylab="")
plot(diff(ts_umcsent), type="l", main=paste("consumer sentiment"),ylab="")
plot(diff(ts_dispic), type="l", main=paste("Disposible income"),ylab="")
plot(diff(ts_permit), type="l", main=paste("Housing permit"),ylab="")
plot(diff(ts_icsa), type="l", main=paste("Jobless claim"),ylab="")
plot(diff(ts_sp500), type="l", main=paste("S&P 500"),ylab="")
```

ACF and PACF

```{r}
data.ts = ts.union(ts_fedfunds,ts_hosr,ts_gdp)
plot(acf(data.ts,plot=FALSE),mar=c(3.5,3,1.9,0))

data.ts = ts.union(ts_cpi,ts_dispic,ts_hosr)
plot(acf(data.ts,plot=FALSE),mar=c(3.5,3,1.9,0))

data.ts = ts.union(ts_hosr,ts_icsa,ts_mspus,ts_payem)
plot(acf(data.ts,plot=FALSE),mar=c(3.5,3,1.9,0))

data.ts = ts.union(ts_hosr,ts_permit,ts_sp500)
plot(acf(data.ts,plot=FALSE),mar=c(3.5,3,1.9,0))

data.ts = ts.union(ts_hosr,ts_umcsent,ts_unrate)
plot(acf(data.ts,plot=FALSE),mar=c(3.5,3,1.9,0))

```
Granger Causality: Wald test

```{r}
var_data <- cbind(ts_hosr,ts_cpi,ts_dispic,ts_fedfunds,ts_gdp,ts_icsa,ts_mspus,ts_payem,ts_permit,ts_sp500,ts_umcsent,ts_unrate)
VARselect(var_data, lag.max = 21)$selection
```

```{r}
model.var=VAR(var_data, p=10)
summary(model.var$varresult$ts_hosr)
## Model Fitting: Restricted VAR
model.var.restrict=restrict(model.var)  
summary(model.var.restrict$varresult$ts_hosr)
```

```{r}
coef.hosr = coefficients(model.var)$ts_hosr[-(12*10+1),1]
var.model = vcov(model.var)[2:121,2:121]
## Granger Causality: CPI
print("CPI")
wald.test(b=coef.hosr, var.model, Terms=seq(2, 12*10, 12))

## Granger Causality: disposible income
print("disposible income")
wald.test(b=coef.hosr, var.model, Terms=seq(3, 12*10, 12))

## Granger Causality: interet rate
print("interet rate")
wald.test(b=coef.hosr, var.model, Terms=seq(4, 12*10, 12))

## Granger Causality: gdp
print("gdp")
wald.test(b=coef.hosr, var.model, Terms=seq(5, 12*10, 12))

## Granger Causality: innial claims
print("innial claims")
wald.test(b=coef.hosr, var.model, Terms=seq(6, 12*10, 12))


## Granger Causality: median housing price
print("median housing price")
wald.test(b=coef.hosr, var.model, Terms=seq(7, 12*10, 12))

## Granger Causality: non farm payroll
print("non farm payroll")
wald.test(b=coef.hosr, var.model, Terms=seq(8, 12*10, 12))


## Granger Causality: housing permit
print("housing permit")
wald.test(b=coef.hosr, var.model, Terms=seq(9, 12*10, 12))


## Granger Causality: sp500
print("sp500")
wald.test(b=coef.hosr, var.model, Terms=seq(10, 12*10, 12))


## Granger Causality: consumer sentiments
print("consumer sentiments")
wald.test(b=coef.hosr, var.model, Terms=seq(11, 12*10, 12))

## Granger Causality: unemployment rate
print("unemployment rate")
wald.test(b=coef.hosr, var.model, Terms=seq(12, 12*10, 12))

```

granger causality test on log

```{r}
var_data <- cbind(ts_hosr_log,ts_cpi_log,ts_dispic_log,ts_fedfunds_log,ts_gdp_log,
                  ts_icsa_log,ts_mspus_log,ts_payem_log,ts_permit_log,ts_sp500_log,ts_umcsent_log,ts_unrate_log)
VARselect(var_data, lag.max = 21)$selection
```

```{r}
model.var=VAR(var_data, p=10)
summary(model.var$varresult$ts_hosr)
## Model Fitting: Restricted VAR
model.var.restrict=restrict(model.var)  
summary(model.var.restrict$varresult$ts_hosr)
```

```{r}
coef.hosr = coefficients(model.var)$ts_hosr[-(12*10+1),1]
var.model = vcov(model.var)[2:121,2:121]
## Granger Causality: CPI
print("CPI")
wald.test(b=coef.hosr, var.model, Terms=seq(2, 12*10, 12))

## Granger Causality: disposible income
print("disposible income")
wald.test(b=coef.hosr, var.model, Terms=seq(3, 12*10, 12))

## Granger Causality: interet rate
print("interet rate")
wald.test(b=coef.hosr, var.model, Terms=seq(4, 12*10, 12))

## Granger Causality: gdp
print("gdp")
wald.test(b=coef.hosr, var.model, Terms=seq(5, 12*10, 12))

## Granger Causality: innial claims
print("innial claims")
wald.test(b=coef.hosr, var.model, Terms=seq(6, 12*10, 12))


## Granger Causality: median housing price
print("median housing price")
wald.test(b=coef.hosr, var.model, Terms=seq(7, 12*10, 12))

## Granger Causality: non farm payroll
print("non farm payroll")
wald.test(b=coef.hosr, var.model, Terms=seq(8, 12*10, 12))


## Granger Causality: housing permit
print("housing permit")
wald.test(b=coef.hosr, var.model, Terms=seq(9, 12*10, 12))


## Granger Causality: sp500
print("sp500")
wald.test(b=coef.hosr, var.model, Terms=seq(10, 12*10, 12))


## Granger Causality: consumer sentiments
print("consumer sentiments")
wald.test(b=coef.hosr, var.model, Terms=seq(11, 12*10, 12))

## Granger Causality: unemployment rate
print("unemployment rate")
wald.test(b=coef.hosr, var.model, Terms=seq(12, 12*10, 12))

```


cointegration-By Leon

```{r}
lm.cpi <- lm(ts_hosr~ts_cpi)
lm.dispic <- lm(ts_hosr~ts_dispic)
lm.fedfunds <- lm(ts_hosr~ts_fedfunds)
lm.gdp <- lm(ts_hosr~ts_gdp)
lm.icsa <- lm(ts_hosr~ts_icsa)
lm.mspus <- lm(ts_hosr~ts_mspus)
lm.payem <- lm(ts_hosr~ts_payem)
lm.permit <- lm(ts_hosr~ts_permit)
lm.sp500 <- lm(ts_hosr~ts_sp500)
lm.umcsent <- lm(ts_hosr~ts_umcsent)
lm.unrate <- lm(ts_hosr~ts_unrate)

coef.cpi <- lm.cpi$coef
coef.dispic <- lm.dispic$coef
coef.fedfunds <- lm.fedfunds$coef
coef.gdp <- lm.gdp$coef
coef.icsa <- lm.icsa$coef
coef.mspus <- lm.mspus$coef
coef.payem <- lm.payem$coef
coef.permit <- lm.permit$coef
coef.sp500 <- lm.sp500$coef
coef.umcsent <- lm.umcsent$coef
coef.unrate <- lm.unrate$coef

resid.lm.cpi <- residuals(lm.cpi)
resid.lm.dispic <- residuals(lm.dispic)
resid.lm.fedfunds <- residuals(lm.fedfunds)
resid.lm.gdp <- residuals(lm.gdp)
resid.lm.icsa <- residuals(lm.icsa)
resid.lm.mspus <- residuals(lm.mspus)
resid.lm.payem <- residuals(lm.payem)
resid.lm.permit <- residuals(lm.permit)
resid.lm.sp500 <- residuals(lm.sp500)
resid.lm.umcsent <- residuals(lm.umcsent)
resid.lm.unrate <- residuals(lm.unrate)

# adf.test(resid.lm.cpi)
# adf.test(resid.lm.dispic)
# adf.test(resid.lm.fedfunds)
# adf.test(resid.lm.gdp)
adf.test(resid.lm.mspus)
adf.test(resid.lm.permit)
adf.test(resid.lm.icsa)
# adf.test(resid.lm.payem)

# adf.test(resid.lm.sp500)
# adf.test(resid.lm.umcsent)
# adf.test(resid.lm.unrate)

# co.resid.cpi <- ts_hosr-(coef.cpi[2]*ts_cpi+coef.cpi[1])
# summary(ur.df(co.resid.cpi, type="none",selectlags="BIC"))
# summary(ur.df(co.resid.cpi, type="drift",selectlags="BIC"))
# summary(ur.df(co.resid.cpi, type="trend",selectlags="BIC"))
#
# co.resid.dispic <- ts_hosr-(coef.dispic[2]*ts_dispic+coef.dispic[1])
# summary(ur.df(co.resid.dispic, type="none",selectlags="BIC"))
# summary(ur.df(co.resid.dispic, type="drift",selectlags="BIC"))
# summary(ur.df(co.resid.dispic, type="trend",selectlags="BIC"))
#
# co.resid.fedfunds <- ts_hosr-(coef.fedfunds[2]*ts_fedfunds+coef.fedfunds[1])
# summary(ur.df(co.resid.fedfunds, type="none",selectlags="BIC"))
# summary(ur.df(co.resid.fedfunds, type="drift",selectlags="BIC"))
# summary(ur.df(co.resid.fedfunds, type="trend",selectlags="BIC"))
#
# co.resid.gdp <- ts_hosr-(coef.gdp[2]*ts_gdp+coef.gdp[1])
# summary(ur.df(co.resid.gdp, type="none",selectlags="BIC"))
# summary(ur.df(co.resid.gdp, type="drift",selectlags="BIC"))
# summary(ur.df(co.resid.gdp, type="trend",selectlags="BIC"))



co.resid.mspus <- ts_hosr-(coef.mspus[2]*ts_mspus+coef.mspus[1])
summary(ur.df(co.resid.mspus, type="none",selectlags="BIC"))
summary(ur.df(co.resid.mspus, type="drift",selectlags="BIC"))
summary(ur.df(co.resid.mspus, type="trend",selectlags="BIC"))

# co.resid.payem <- ts_hosr-(coef.payem[2]*ts_payem+coef.payem[1])
# summary(ur.df(co.resid.payem, type="none",selectlags="BIC"))
# summary(ur.df(co.resid.payem, type="drift",selectlags="BIC"))
# summary(ur.df(co.resid.payem, type="trend",selectlags="BIC"))

co.resid.permit <- ts_hosr-(coef.permit[2]*ts_permit+coef.permit[1])
summary(ur.df(co.resid.permit, type="none",selectlags="BIC"))
summary(ur.df(co.resid.permit, type="drift",selectlags="BIC"))
summary(ur.df(co.resid.permit, type="trend",selectlags="BIC"))

co.resid.icsa <- ts_hosr-(coef.icsa[2]*ts_icsa+coef.icsa[1])
summary(ur.df(co.resid.icsa, type="none",selectlags="BIC"))
summary(ur.df(co.resid.icsa, type="drift",selectlags="BIC"))
summary(ur.df(co.resid.icsa, type="trend",selectlags="BIC"))

# co.resid.sp500 <- ts_hosr-(coef.sp500[2]*ts_sp500+coef.sp500[1])
# summary(ur.df(co.resid.sp500, type="none",selectlags="BIC"))
# summary(ur.df(co.resid.sp500, type="drift",selectlags="BIC"))
# summary(ur.df(co.resid.sp500, type="trend",selectlags="BIC"))
#
# co.resid.umcsent <- ts_hosr-(coef.umcsent[2]*ts_umcsent+coef.umcsent[1])
# summary(ur.df(co.resid.umcsent, type="none",selectlags="BIC"))
# summary(ur.df(co.resid.umcsent, type="drift",selectlags="BIC"))
# summary(ur.df(co.resid.umcsent, type="trend",selectlags="BIC"))
#
# co.resid.unrate <- ts_hosr-(coef.unrate[2]*ts_unrate+coef.unrate[1])
# summary(ur.df(co.resid.unrate, type="none",selectlags="BIC"))
# summary(ur.df(co.resid.unrate, type="drift",selectlags="BIC"))
# summary(ur.df(co.resid.unrate, type="trend",selectlags="BIC"))```
```
cointegration-By Baiyan

```{r}
# original data - returns the same results as above
lm.mspus <- lm(ts_hosr~ts_mspus)
lm.permit <- lm(ts_hosr~ts_permit)
lm.icsa <- lm(ts_hosr~ts_icsa)
adf.test(residuals(lm.mspus))
adf.test(residuals(lm.permit))
adf.test(residuals(lm.icsa))
summary(ur.df(residuals(lm.mspus), type="none", selectlags="BIC"))
summary(ur.df(residuals(lm.mspus), type="drift", selectlags="BIC"))
summary(ur.df(residuals(lm.mspus), type="trend", selectlags="BIC"))
```
```{r}
# log transformed data - no cointegration detected
lm.mspus_log <- lm(log(ts_hosr)~log(ts_mspus))
lm.permit_log <- lm(log(ts_hosr)~log(ts_permit))
lm.icsa_log <- lm(log(ts_hosr)~log(ts_icsa))

adf.test(residuals(lm.mspus_log))
adf.test(residuals(lm.permit_log))
adf.test(residuals(lm.icsa_log))

summary(ur.df(residuals(lm.mspus_log), type="none", selectlags="BIC"))
summary(ur.df(residuals(lm.mspus_log), type="drift", selectlags="BIC"))
summary(ur.df(residuals(lm.mspus_log), type="trend", selectlags="BIC"))

summary(ur.df(residuals(lm.permit_log), type="none", selectlags="BIC"))
summary(ur.df(residuals(lm.permit_log), type="drift", selectlags="BIC"))
summary(ur.df(residuals(lm.permit_log), type="trend", selectlags="BIC"))

summary(ur.df(residuals(lm.icsa_log), type="none", selectlags="BIC"))
summary(ur.df(residuals(lm.icsa_log), type="drift", selectlags="BIC"))
summary(ur.df(residuals(lm.icsa_log), type="trend", selectlags="BIC"))
```

Trend Estimation + ARMA org

```{r}
time.pts = c(1:length(hosr[,"hosr"]))
time.pts = c(time.pts - min(time.pts))/max(time.pts)
x <- time.pts[1:153]
m_spl_org = gam(training[,"hosr"]~s(x))
m_spl_org.fit = fitted(m_spl_org)
m_spl_org.fit = ts(m_spl_org.fit,start=1980, freq=4)
resid.process = training[,"hosr"]-m_spl_org.fit
resid.process = ts(resid.process,start=1980, freq=4)
par(mfrow=c(2,2))
plot(ts_hosr,xlab="Years",ylab="Home ownership rate",type="l")
lines(m_spl_org.fit,lwd=2,col="blue")
plot(resid.process,xlab="Years",ylab="De-Trended Time Series",type="l")
acf(resid.process,main="ACF: De-trended TS")
pacf(resid.process,main="PACF: De-trended TS")
```
## order selection  ---AICC

```{r}
n = length(resid.process)
norder = 6

aicc <- data.frame(Inf,Inf,Inf,Inf)
names(aicc) <- c("p","d","q","aicc")

test_arima <- function(train,p,d,q,n){
  fit <-arima(train,order = c(p,d,q), method='ML')
  curr.aicc <- fit$aic-2*(p+q+1)+2*(p+q+1)*n/(n-p-q-2)
  df <- data.frame(p,d,q,curr.aicc)
  names(df) <- c("p","d","q","aicc")
  return(df)
}

for(p in 1:norder){
  for(d in 0:1){
    for(q in 1:norder){
                aicc = rbind(aicc,test_arima(resid.process,p,d,q,n))
   } 
  }
}

aicc <- aicc[order(aicc$aicc),]
m1.orders = c(aicc$p[1],aicc$d[1],aicc$q[1])
```

fit ARMA model

```{r}
m_arma_org = arima(resid.process,order = m1.orders, method='ML')
m_arma_org.res = resid(m_arma_org)
## Residual Analysis
par (mfrow=c(2,2))
plot(m_arma_org.res, ylab='Standardized Residuals')
abline(h=0)
acf(m_arma_org.res,main= 'ACF of the Model Residuals')
pacf(m_arma_org.res,main='PACF of the Model Residuals')
qqnorm(m_arma_org.res)
qqline(m_arma_org.res)
```
The de-trended time series shows that the trend has been removed. the residuals are normally distributed. The ACF and PACF plots
show also that it is plausible that the de-trended time series is stationary.



trend estimation and ARMA log

```{r}
time.pts = c(1:length(hosr_log[,"hosr"]))
time.pts = c(time.pts - min(time.pts))/max(time.pts)
x <- time.pts[1:153]
m_spl_log = gam(training_log[,"hosr"]~s(x))
m_spl_log.fit = fitted(m_spl_log)
m_spl_log.fit = ts(m_spl_log.fit,start=1980, freq=4)
resid.process = training_log[,"hosr"]-m_spl_log.fit
resid.process = ts(resid.process,start=1980, freq=4)
par(mfrow=c(2,2))
plot(ts_hosr_log,xlab="Years",ylab="Home ownership rate",type="l")
lines(m_spl_log.fit,lwd=2,col="blue")
plot(resid.process,xlab="Years",ylab="De-Trended Time Series",type="l")
acf(resid.process,main="ACF: De-trended TS")
pacf(resid.process,main="PACF: De-trended TS")
```
```{r}
n = length(resid.process)
norder = 6

aicc <- data.frame(Inf,Inf,Inf,Inf)
names(aicc) <- c("p","d","q","aicc")

test_arima <- function(train,p,d,q,n){
  fit <-arima(train,order = c(p,d,q), method='ML')
  curr.aicc <- fit$aic-2*(p+q+1)+2*(p+q+1)*n/(n-p-q-2)
  df <- data.frame(p,d,q,curr.aicc)
  names(df) <- c("p","d","q","aicc")
  return(df)
}

for(p in 1:norder){
  for(d in 0:1){
    for(q in 1:norder){
                aicc = rbind(aicc,test_arima(resid.process,p,d,q,n))
   } 
  }
}

aicc <- aicc[order(aicc$aicc),]
m1.orders = c(aicc$p[1],aicc$d[1],aicc$q[1])
```

fit ARMA model log

```{r}
m_arma_log = arima(resid.process,order = m1.orders, method='ML')
m_arma_log.res = resid(m_arma_log)
## Residual Analysis
par (mfrow=c(2,2))
plot(m_arma_log.res, ylab='Standardized Residuals')
abline(h=0)
acf(m_arma_log.res,main= 'ACF of the Model Residuals')
pacf(m_arma_log.res,main='PACF of the Model Residuals')
qqnorm(m_arma_log.res)
qqline(m_arma_log.res)
```
The de-trended time series shows that the trend has been removed. the residuals are normally distributed. The ACF and PACF plots
show also that it is plausible that the de-trended time series is stationary.




## ARIMA model on original data

```{r}
n = length(training[,"hosr"])
norder = 6

aicc <- data.frame(Inf,Inf,Inf,Inf)
names(aicc) <- c("p","d","q","aicc")

test_arima <- function(train,p,d,q,n){
  fit <-arima(train,order = c(p,d,q), method='ML')
  curr.aicc <- fit$aic-2*(p+q+1)+2*(p+q+1)*n/(n-p-q-2)
  df <- data.frame(p,d,q,curr.aicc)
  names(df) <- c("p","d","q","aicc")
  return(df)
}

for(p in 1:norder){
  for(d in 0:1){
    for(q in 1:norder){

      possibleError <- tryCatch(
          aicc <- rbind(aicc,test_arima(training[,"hosr"],p,d,q,n)),
          error = function(e) e
        )
        if(inherits(possibleError,"error")) next
   } 
  }
}

aicc <- aicc[order(aicc$aicc),]
m2.orders = c(aicc$p[1],aicc$d[1],aicc$q[1])

```

```{r}
m_arima_ori = arima(training[,"hosr"], order = m2.orders, method = "ML")
m_arima_ori.res = resid(m_arima_ori)
## Residual Analysis
par (mfrow=c(2,2))
plot(m_arima_ori.res, ylab='Standardized Residuals')
abline(h=0)
acf(m_arima_ori.res,main= 'ACF of the Model Residuals')
pacf(m_arima_ori.res,main='PACF of the Model Residuals')
qqnorm(m_arima_ori.res)
qqline(m_arima_ori.res)

Box.test(m_arima_ori$resid, lag = (aicc$p[1]+aicc$q[1]+1), type = "Box-Pierce", fitdf = (aicc$p[1]+aicc$q[1]))
Box.test(m_arima_ori$resid, lag = (aicc$p[1]+aicc$q[1]+1), type = "Ljung-Box", fitdf = (aicc$p[1]+aicc$q[1]))
```

## ARIMA model on log data
```{r}
n = length(training_log[,"hosr"])
norder = 6

aicc <- data.frame(Inf,Inf,Inf,Inf)
names(aicc) <- c("p","d","q","aicc")

for(p in 1:norder){
  for(d in 0:1){
    for(q in 1:norder){

      possibleError <- tryCatch(
          aicc <- rbind(aicc,test_arima(training_log[,"hosr"],p,d,q,n)),
          error = function(e) e
        )
        if(inherits(possibleError,"error")) next
   }
  }
}

aicc <- aicc[order(aicc$aicc),]
m2.orders = c(aicc$p[1],aicc$d[1],aicc$q[1])

```
```{r}
m_arima_log = arima(training_log[,"hosr"], order = m2.orders, method = "ML")
m_arima_log.res = resid(m_arima_log)
## Residual Analysis
par (mfrow=c(2,2))
plot(m_arima_log.res, ylab='Standardized Residuals')
abline(h=0)
acf(m_arima_log.res,main= 'ACF of the Model Residuals')
pacf(m_arima_log.res,main='PACF of the Model Residuals')
qqnorm(m_arima_log.res)
qqline(m_arima_log.res)

Box.test(m_arima_log$resid, lag = (aicc$p[1]+aicc$q[1]+1), type = "Box-Pierce", fitdf = (aicc$p[1]+aicc$q[1]))
Box.test(m_arima_log$resid, lag = (aicc$p[1]+aicc$q[1]+1), type = "Ljung-Box", fitdf = (aicc$p[1]+aicc$q[1]))
```

##  var model org

```{r}
var_data_train <- cbind(ts_hosr,ts_icsa,ts_mspus,ts_permit)
var_data_train <- var_data_train[1:(n-15),]

VARselect(var_data_train, lag.max = 20)$selection

```

```{r}
m_var_org=VAR(var_data_train, p=2)
summary(m_var_org$varresult$ts_hosr)
## Model Fitting: Restricted VAR
m_rs_var_org=restrict(m_var_org)  
summary(m_rs_var_org$varresult$ts_hosr)
```

residuals of var
```{r}
m_var_org.res = resid(m_var_org)[,"ts_hosr"]

## Residual Analysis

par (mfrow=c(2,2))
plot(m_var_org.res, ylab='Standardized Residuals')
abline(h=0)
acf(m_var_org.res,main= 'ACF of the Model Residuals')
pacf(m_var_org.res,main='PACF of the Model Residuals')
qqnorm(m_var_org.res)
qqline(m_var_org.res)

m_rs_var_org.res = resid(m_rs_var_org)[,"ts_hosr"]

## Residual Analysis

par (mfrow=c(2,2))
plot(m_rs_var_org.res, ylab='Standardized Residuals')
abline(h=0)
acf(m_rs_var_org.res,main= 'ACF of the Model Residuals')
pacf(m_rs_var_org.res,main='PACF of the Model Residuals')
qqnorm(m_rs_var_org.res)
qqline(m_rs_var_org.res)
```
The residual is weakly stationary with few bars slightly outside of the significant band and the residual seems to be roughly normally distributed with few points at fat tails.


## var model log

```{r}
var_data_train <- cbind(ts_hosr_log,ts_icsa_log)
var_data_train <- var_data_train[1:(n-15),]

VARselect(var_data_train, lag.max = 20)$selection

```

```{r}
m_var_log=VAR(var_data_train, p=2)
summary(m_var_log$varresult$ts_hosr)
## Model Fitting: Restricted VAR
m_rs_var_log=restrict(m_var_log)  
summary(m_rs_var_log$varresult$ts_hosr)
```

residuals of var
```{r}
m_var_log.res = resid(m_var_log)[,"ts_hosr_log"]

## Residual Analysis

par (mfrow=c(2,2))
plot(m_var_log.res, ylab='Standardized Residuals')
abline(h=0)
acf(m_var_log.res,main= 'ACF of the Model Residuals')
pacf(m_var_log.res,main='PACF of the Model Residuals')
qqnorm(m_var_log.res)
qqline(m_var_log.res)

m_rs_var_log.res = resid(m_rs_var_log)[,"ts_hosr_log"]

## Residual Analysis

par (mfrow=c(2,2))
plot(m_rs_var_log.res, ylab='Standardized Residuals')
abline(h=0)
acf(m_rs_var_log.res,main= 'ACF of the Model Residuals')
pacf(m_rs_var_log.res,main='PACF of the Model Residuals')
qqnorm(m_rs_var_log.res)
qqline(m_rs_var_log.res)
```
The residual is weakly stationary with few bars slightly outside of the significant band and the residual seems to be roughly normally distributed with few points at fat tails.

For the restricted model, the residuals fall into few constant values and thus the QQ plots exhibits a zigzag pattern, which is weird




##  varx org

```{r}
##Model Selection
VARselect(cbind(ts_hosr[1:153],ts_icsa[1:153]), lag.max = 20,exogen=data.frame(ts_mspus[1:153],ts_permit[1:153]))$selection

```

```{r}
## Model Fitting: Unrestricted VAR
m_varx_org=VAR(data.frame(hosr=ts_hosr[1:153],icsa=ts_icsa[1:153]), p=2,exogen=data.frame(mspus=ts_mspus[1:153],permit=ts_permit[1:153]))
summary(m_varx_org)

## Model Fitting: Restricted VAR
m_rs_varx_org=restrict(m_varx_org)  
summary(m_rs_varx_org)
```


residuals of varx
```{r}
m_varx_org.res = resid(m_varx_org)[,"hosr"]

## Residual Analysis

par (mfrow=c(2,2))
plot(m_varx_org.res, ylab='Standardized Residuals')
abline(h=0)
acf(m_varx_org.res,main= 'ACF of the Model Residuals')
pacf(m_varx_org.res,main='PACF of the Model Residuals')
qqnorm(m_varx_org.res)
qqline(m_varx_org.res)

m_rs_varx_org.res = resid(m_rs_varx_org)[,"hosr"]

## Residual Analysis

par (mfrow=c(2,2))
plot(m_rs_varx_org.res, ylab='Standardized Residuals')
abline(h=0)
acf(m_rs_varx_org.res,main= 'ACF of the Model Residuals')
pacf(m_rs_varx_org.res,main='PACF of the Model Residuals')
qqnorm(m_rs_varx_org.res)
qqline(m_rs_varx_org.res)
```

## ARIMAX on original data
```{r}
columns = c("MSPUS","PERMIT","ICSA")
x_reg = training[, columns]
y = training[, "hosr"]
m_arimax_ori = auto.arima(y, xreg = as.matrix(x_reg))
m_arimax_ori
```
```{r}
m_arimax_ori_pred = forecast(m_arimax_ori, xreg = as.matrix(testing[, columns]))
# plot
plot(m_arimax_ori_pred)
lines(fitted(m_arimax_ori), col="yellow")
lines(c(154:168), testing[, "hosr"])
```
```{r}
m_arimax_ori.res = m_arimax_ori_pred$residuals
## Residual Analysis
par (mfrow=c(2,2))
plot(m_arimax_ori.res, ylab='Standardized Residuals')
abline(h=0)
acf(m_arimax_ori.res,main= 'ACF of the Model Residuals')
pacf(m_arimax_ori.res,main='PACF of the Model Residuals')
qqnorm(m_arimax_ori.res)
qqline(m_arimax_ori.res)

Box.test(m_arimax_ori$resid, lag = 1, type = "Box-Pierce", fitdf = 1)
Box.test(m_arimax_ori$resid, lag = 1, type = "Ljung-Box", fitdf = 1)
```
## ARIMAX on log data
```{r}
columns = c("ICSA")
x_reg = training_log[, columns]
y = training_log[, "hosr"]
m_arimax_log = auto.arima(y, xreg = as.matrix(x_reg))
m_arimax_log
```
```{r}
m_arimax_log_pred = forecast(m_arimax_log, xreg = as.matrix(testing_log[, columns]))
# plot
plot(m_arimax_log_pred)
lines(fitted(m_arimax_log), col="yellow")
lines(c(154:168), testing_log[, "hosr"])
```
```{r}
m_arimax_log.res = m_arimax_log_pred$residuals
## Residual Analysis
par (mfrow=c(2,2))
plot(m_arimax_log.res, ylab='Standardized Residuals')
abline(h=0)
acf(m_arimax_log.res,main= 'ACF of the Model Residuals')
pacf(m_arimax_log.res,main='PACF of the Model Residuals')
qqnorm(m_arimax_log.res)
qqline(m_arimax_log.res)

Box.test(m_arimax_log$resid, lag = 4, type = "Box-Pierce", fitdf = 4)
Box.test(m_arimax_log$resid, lag = 4, type = "Ljung-Box", fitdf = 4)
```

## prediction

gam+arma org
```{r}
n = length(time.pts)
nfit=n-15
newdata = data.frame(x=time.pts[(nfit+1):n])
gam.pred= predict(m_spl_org,newdata = newdata,interval=c("prediction"))
outpredresid = predict(m_arma_org,n.ahead=15)$pred
## Add up the predictions
m_gam_arma_org.pred = outpredresid+gam.pred
```

gam+arma log
```{r}
n = length(time.pts)
nfit=n-15
newdata = data.frame(x=time.pts[(nfit+1):n])
gam.pred= predict(m_spl_log,newdata = newdata,interval=c("prediction"))
outpredresid = predict(m_arma_log,n.ahead=15)$pred
## Add up the predictions
m_gam_arma_log.pred = exp(outpredresid+gam.pred)
```

var model org

```{r}
m_var_org.pred = predict(m_var_org,n.ahead=15)$fcst$ts_hosr[,1]
m_rs_var_org.pred = predict(m_rs_var_org,n.ahead=15)$fcst$ts_hosr[,1]
```

var model log

```{r}
m_var_log.pred = exp(predict(m_var_log,n.ahead=15)$fcst$ts_hosr[,1])
m_rs_var_log.pred = exp(predict(m_rs_var_log,n.ahead=15)$fcst$ts_hosr[,1])
```

varx model org

```{r}
x = data.frame(mspus=ts_mspus[154:168],permit=ts_permit[154:168])
m_varx_org.pred = predict(m_varx_org,n.ahead=15,dumvar=x)$fcst$hosr[,1]
m_rs_varx_org.pred = predict(m_rs_varx_org,n.ahead=15,dumvar=x)$fcst$hosr[,1]
```

ARIMA

```{r}
m_arima_ori_pred = predict(m_arima_ori,n.ahead=15)
m_arima_ori_pred.pred = m_arima_ori_pred$pred
m_arima_ori_pred.ubound = m_arima_ori_pred.pred+1.96*m_arima_ori_pred$se
m_arima_ori_pred.lbound = m_arima_ori_pred.pred-1.96*m_arima_ori_pred$se

m_arima_log_pred = predict(m_arima_log, n.ahead=15)
m_arima_log_pred.pred = exp(m_arima_log_pred$pred)
m_arima_log_pred.ubound = exp(m_arima_log_pred$pred+1.96*m_arima_log_pred$se)
m_arima_log_pred.lbound = exp(m_arima_log_pred$pred-1.96*m_arima_log_pred$se)
```


ARIMAX
```{r}
m_arimax_ori_pred.pred = data.frame(m_arimax_ori_pred)[,"Point.Forecast"]
m_arimax_ori_pred.ubound = data.frame(m_arimax_ori_pred)[, "Hi.95"]
m_arimax_ori_pred.lbound = data.frame(m_arimax_ori_pred)[, "Lo.95"]

m_arimax_log_pred.pred = data.frame(m_arimax_log_pred)[,"Point.Forecast"]
m_arimax_log_pred.ubound = data.frame(m_arimax_log_pred)[, "Hi.95"]
m_arimax_log_pred.lbound = data.frame(m_arimax_log_pred)[, "Lo.95"]
```

## plot

```{r}
ts.plot(ts_hosr,main="All Forecasts",ylab="homeownership rate",ylim=c(62,69))
points(ts(m_gam_arma_org.pred,start=2018.25,freq=4),lwd=2,col="red")
points(ts(m_gam_arma_log.pred,start=2018.25,freq=4),lwd=2,col="orange")
points(ts(m_var_org.pred,start=2018.25,freq=4),lwd=2,col="blue")
points(ts(m_rs_var_org.pred,start=2018.25,freq=4),lwd=2,col="lightblue")
points(ts(m_var_log.pred,start=2018.25,freq=4),lwd=2,col="darkgreen")
points(ts(m_rs_var_log.pred,start=2018.25,freq=4),lwd=2,col="green")
points(ts(m_varx_org.pred,start=2018.25,freq=4),lwd=2,col="lightgreen")
points(ts(m_rs_varx_org.pred,start=2018.25,freq=4),lwd=2,col="pink")
points(ts(m_arima_ori_pred.pred,start=2018.25,freq=4),lwd=2,col="yellow")
points(ts(m_arima_ori_pred.pred,start=2018.25,freq=4),lwd=2,col="grey")
points(ts(m_arima_log_pred.pred,start=2018.25,freq=4),lwd=2,col="darkblue")
points(ts(m_arima_log_pred.pred,start=2018.25,freq=4),lwd=2,col="darkred")
#legend(x=1980,y=69,legend=c("model1","model2","model3a","model3b","model4a","model4b"),pch=1,
#       pt.lwd = 2, col=c("red","orange","blue","lightblue","darkgreen","green"))
```
PM, MAPE

```{r}
testing$hosr
cat("Model1 MAPE:",mean(abs(final.pred.1-testing$hosr)/testing$hosr),
   "\nModel1 PM:", sum((final.pred.1-testing$hosr)^2)/sum((testing$hosr-mean(testing$hosr))^2),
"\nModel2 MAPE:",mean(abs(final.pred.2-testing$hosr)/testing$hosr),
"\nModel2 PM:", sum((final.pred.2-testing$hosr)^2)/sum((testing$hosr-mean(testing$hosr))^2),
"\nModel3a MAPE:",mean(abs(final.pred.3a-testing$hosr)/testing$hosr),
"\nModel3a PM:", sum((final.pred.3a-testing$hosr)^2)/sum((testing$hosr-mean(testing$hosr))^2),
"\nModel3b MAPE:",mean(abs(final.pred.3b-testing$hosr)/testing$hosr),
"\nModel3b PM:", sum((final.pred.3b-testing$hosr)^2)/sum((testing$hosr-mean(testing$hosr))^2),
"\nModel4a MAPE:",mean(abs(final.pred.4a-testing$hosr)/testing$hosr),
"\nModel4a PM:", sum((final.pred.4a-testing$hosr)^2)/sum((testing$hosr-mean(testing$hosr))^2),
"\nModel4b MAPE:",mean(abs(final.pred.4b-testing$hosr)/testing$hosr),
"\nModel4b PM:", sum((final.pred.4b-testing$hosr)^2)/sum((testing$hosr-mean(testing$hosr))^2))
```










