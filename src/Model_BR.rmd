---
title: "R Notebook"
output: html_notebook
---

```{r}
setwd("C:/Users/emrqyw7/OneDrive - McKesson Corporation/Training/OMSCS/tsa/tsa_code/project")
print('Working directory reset to ../project')
```

```{r}
library(mgcv)
library(lubridate)
library(dplyr)
library(xts)
library(ggplot2)
library(ggpubr)
library(corrplot)
library(dynlm)
library(lmtest)
library(zoo)
library(data.table)
library(forecast)
library(huxtable)
library(magrittr)
library(kableExtra)
library(tseries)
library(gridExtra)

```
```{r}
hosr_var_fpath <- "data/hosr_var.csv"

hosr_var_df <- read.csv(hosr_var_fpath)
```
```{r}
time_points <- c(1:length(hosr_var_df$date))
time_points <- c(time_points - min(time_points))/max(time_points)

hosr_ts <- ts(hosr_var_df$hosr,start = 1980, frequency = 4)

# Splines Trend Estimation
gam_model <- gam(hosr_ts~s(time_points))
gam_fit <- ts(fitted(gam_model),start=1980,frequency=4)

# plot
ts.plot(hosr_ts,xlab="",ylab="homeownership rate",main = "Trend Estimation with Benchmark model")
lines(gam_fit,lwd=2,col="purple")

legend("topleft", legend = c("Splines regression"), col = c("purple"), lwd = 2)
```

```{r}
gam_resid <- hosr_ts-gam_fit

par(mfrow=c(2,2))
plot(gam_resid, ylab='Residuals',type='o',main="Residual Plot")
abline(h=0)
acf(gam_resid,main="ACF: Residuals")
hist(gam_resid,xlab='Residuals',main='Histogram: Residuals')
qqnorm(gam_resid,ylab="Sample Q",xlab="Theoretical Q")
qqline(gam_resid)
```
The Splines regression model captures the non-linear trend of the homeownership rate data, though the peak during COVID-19 in 2020 is not fitted. The residuals of the model assemble normal distribution. Mean and variance of residuals are not constant due to the peak in 2020. ACF plot showed that the residuals are not stationary yet.
```{r}
head(hosr_var_df)
```
```{r}
ORDER=1
grangertest(hosr ~ FEDFUNDS, order=ORDER, data=hosr_var_df)
grangertest(hosr ~ MSPUS, order=ORDER, data=hosr_var_df)
grangertest(hosr ~ GDPC1, order=ORDER, data=hosr_var_df)
grangertest(hosr ~ PAYEMS, order=ORDER, data=hosr_var_df)
grangertest(hosr ~ CPIAUCSL, order=ORDER, data=hosr_var_df)
grangertest(hosr ~ UNRATE, order=ORDER, data=hosr_var_df)
grangertest(hosr ~ UMCSENT, order=ORDER, data=hosr_var_df)
grangertest(hosr ~ DSPIC96, order=ORDER, data=hosr_var_df)
grangertest(hosr ~ PERMIT, order=ORDER, data=hosr_var_df)
grangertest(hosr ~ ICSA, order=ORDER, data=hosr_var_df)
grangertest(hosr ~ SP500, order=ORDER, data=hosr_var_df)
# UNRATE, UMCSENT, PERMIT, ICSA
```
```{r}
ORDER = 2
grangertest(hosr ~ FEDFUNDS, order=ORDER, data=hosr_var_df)
grangertest(hosr ~ MSPUS, order=ORDER, data=hosr_var_df)
grangertest(hosr ~ GDPC1, order=ORDER, data=hosr_var_df)
grangertest(hosr ~ PAYEMS, order=ORDER, data=hosr_var_df)
grangertest(hosr ~ CPIAUCSL, order=ORDER, data=hosr_var_df)
grangertest(hosr ~ UNRATE, order=ORDER, data=hosr_var_df)
grangertest(hosr ~ UMCSENT, order=ORDER, data=hosr_var_df)
grangertest(hosr ~ DSPIC96, order=ORDER, data=hosr_var_df)
grangertest(hosr ~ PERMIT, order=ORDER, data=hosr_var_df)
grangertest(hosr ~ ICSA, order=ORDER, data=hosr_var_df)
grangertest(hosr ~ SP500, order=ORDER, data=hosr_var_df)
# UNRATE, UMCSENT, PERMIT, ICSA
```
```{r}
ORDER = 4
grangertest(hosr ~ FEDFUNDS, order=ORDER, data=hosr_var_df)
grangertest(hosr ~ MSPUS, order=ORDER, data=hosr_var_df)
grangertest(hosr ~ GDPC1, order=ORDER, data=hosr_var_df)
grangertest(hosr ~ PAYEMS, order=ORDER, data=hosr_var_df)
grangertest(hosr ~ CPIAUCSL, order=ORDER, data=hosr_var_df)
grangertest(hosr ~ UNRATE, order=ORDER, data=hosr_var_df)
grangertest(hosr ~ UMCSENT, order=ORDER, data=hosr_var_df)
grangertest(hosr ~ DSPIC96, order=ORDER, data=hosr_var_df)
grangertest(hosr ~ PERMIT, order=ORDER, data=hosr_var_df)
grangertest(hosr ~ ICSA, order=ORDER, data=hosr_var_df)
grangertest(hosr ~ SP500, order=ORDER, data=hosr_var_df)
# GDPC1, PAYEMS, UNRATE, UMCSENT, DSPIC96, ICSA
```
```{r}
# set lag size, test data size
n_lag = 4
n_data = length(hosr_var_df$hosr)
n_test = 16
# extract exogenous variable
columns = c("PAYEMS", "GDPC1", "UNRATE", "UMCSENT","PERMIT","ICSA")
log_exog_var_df = log(hosr_var_df[, columns])
```
```{r}
# split training, testing data
train_exog_df = log_exog_var_df[1:(n_data-n_lag-n_test), 1:length(columns)]
test_exog_df = log_exog_var_df[(n_data-n_lag-n_test+1):(n_data-n_lag), 1:length(columns)]

train_y = ts(log(hosr_var_df$hosr[(n_lag+1):(n_data-n_test)]), start = c(1981, 1, 1), frequency=4)
test_y = ts(log(hosr_var_df$hosr[(n_data-n_test+1):(n_data)]), start = c(2017, 4, 1), frequency=4)
# auto arima
model_1 = auto.arima(train_y, xreg = as.matrix(train_exog_df))

pred_y = forecast(model_1, xreg = as.matrix(test_exog_df))
# plot
plot(pred_y)
lines(fitted(model_1), col="yellow")
lines(test_y)
```
We used six exogenous variables: real GDP, non farm payroll, unemployment rate, UMCSENT (), housing permit, and initial claim. To normalize the data, we employed log transformation on both dependent and independent variables.
```{r}
accuracy(pred_y)
```
```{r}
train_exog_df = log_exog_var_df[1:(n_data-n_lag), 1:4]
forecast_exog_df = log_exog_var_df[(n_data-n_lag+1): n_data, 1:4]
train_y = ts(log(hosr_var_df$hosr[(n_lag+1):n_data]), start = c(1981, 1, 1), frequency=4)
model_2 = auto.arima(train_y, xreg = as.matrix(train_exog_df),
                     max.p = 6, max.q = 6, max.P = 2, max.Q = 2, max.order = 8, ic='aicc')
forecast_y = forecast(model_2, xreg = as.matrix(forecast_exog_df))
plot(forecast_y)
```
```{r}
train_y = ts(hosr_var_df$hosr[(n_lag+1):(n_data-n_test)], start = c(1981, 1, 1), frequency=4)
test_y = ts(hosr_var_df$hosr[(n_data-n_test+1):(n_data)], start = c(2014, 4, 1), frequency=4)
# auto arima
model_3 = auto.arima(train_y, max.p = 2, max.q = 2, max.P = 2, max.Q = 2, max.order = 6,
                 max.d = 1, max.D = 1, ic='bic',
                 stepwise=FALSE)
pred_y = forecast(model_3, h=n_test)
# plot
plot(pred_y)
lines(test_y)
```
